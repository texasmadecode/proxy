<!DOCTYPE html>
<html>
<head>
    <title>VPN Tunnel - Netflix</title>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #vpn-status {
            position: fixed; top: 0; left: 0; right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 12px 20px; z-index: 999999;
            display: flex; align-items: center; justify-content: space-between;
        }
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%;
            background: #4ade80; margin-right: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #content-frame {
            position: fixed; top: 44px; left: 0; right: 0; bottom: 0;
            width: 100%; border: none;
        }
        .loading {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px; color: #667eea;
        }
    </style>
</head>
<body>
    <div id="vpn-status">
        <div style="display: flex; align-items: center;">
            <div class="status-dot"></div>
            <strong>üîí VPN TUNNEL ACTIVE</strong>
            <span style="margin-left: 20px; opacity: 0.8;">Encrypted WebSocket</span>
        </div>
        <div id="stats">0 requests</div>
    </div>
    <div class="loading" id="loading">Establishing encrypted tunnel...</div>
    <iframe id="content-frame" style="display:none;"></iframe>

    <script>
        class VPNTunnel {
            constructor() {
                this.ws = null;
                this.requestCount = 0;
                this.connected = false;
                this.pendingRequest = null;
            }

            async connect() {
                return new Promise((resolve, reject) => {
                    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = protocol + '//' + location.host + '/tunnel';
                    
                    console.log('[VPN] Connecting to:', wsUrl);
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        console.log('[VPN] ‚úì Connected');
                        this.connected = true;
                        resolve();
                    };
                    
                    this.ws.onmessage = (event) => {
                        this.handleResponse(event.data);
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('[VPN] Error:', error);
                        reject(error);
                    };
                });
            }

            encrypt(data) {
                const key = 0x5A;
                const bytes = new TextEncoder().encode(data);
                const encrypted = new Uint8Array(bytes.length);
                for (let i = 0; i < bytes.length; i++) {
                    encrypted[i] = bytes[i] ^ key;
                }
                return btoa(String.fromCharCode(...encrypted));
            }

            decrypt(data) {
                const key = 0x5A;
                const decoded = atob(data);
                const bytes = new Uint8Array(decoded.length);
                for (let i = 0; i < decoded.length; i++) {
                    bytes[i] = decoded.charCodeAt(i) ^ key;
                }
                return new TextDecoder().decode(bytes);
            }

            async request(url, options = {}) {
                return new Promise((resolve, reject) => {
                    const requestData = {
                        url: url,
                        method: options.method || 'GET',
                        headers: options.headers || {}
                    };
                    
                    // Store the promise resolver
                    this.pendingRequest = { resolve, reject };
                    
                    const encrypted = this.encrypt(JSON.stringify(requestData));
                    this.ws.send(encrypted);
                    
                    this.requestCount++;
                    document.getElementById('stats').textContent = this.requestCount + ' requests';
                    console.log('[VPN] ‚Üí GET ' + url);
                });
            }

            handleResponse(encryptedData) {
                try {
                    console.log('[VPN] Received encrypted response, decrypting...');
                    const decrypted = this.decrypt(encryptedData);
                    console.log('[VPN] Decrypted, parsing JSON...');
                    const response = JSON.parse(decrypted);
                    
                    console.log('[VPN] ‚Üê Status:', response.status, 'Body length:', response.body.length);
                    
                    if (response.status === 200) {
                        console.log('[VPN] Decoding base64 body...');
                        const bodyData = atob(response.body);
                        console.log('[VPN] Body decoded, length:', bodyData.length);
                        
                        const contentType = response.headers['content-type'] || '';
                        console.log('[VPN] Content-Type:', contentType);
                        
                        if (contentType.includes('text/html')) {
                            console.log('[VPN] Loading HTML...');
                            this.loadHTML(bodyData);
                        } else {
                            console.log('[VPN] Not HTML, skipping');
                        }
                        
                        // Resolve the pending request
                        if (this.pendingRequest) {
                            this.pendingRequest.resolve(response);
                            this.pendingRequest = null;
                        }
                    } else {
                        console.log('[VPN] Non-200 status:', response.status);
                        if (this.pendingRequest) {
                            this.pendingRequest.reject(new Error('Status: ' + response.status));
                            this.pendingRequest = null;
                        }
                    }
                } catch (e) {
                    console.error('[VPN] Error handling response:', e);
                    console.error('[VPN] Stack:', e.stack);
                    if (this.pendingRequest) {
                        this.pendingRequest.reject(e);
                        this.pendingRequest = null;
                    }
                }
            }

            loadHTML(html) {
                console.log('[VPN] loadHTML called with', html.length, 'bytes');
                const frame = document.getElementById('content-frame');
                const loading = document.getElementById('loading');
                
                console.log('[VPN] Hiding loading, showing frame...');
                frame.style.display = 'block';
                loading.style.display = 'none';
                
                // Add banner to HTML
                console.log('[VPN] Injecting banner...');
                html = html.replace('<body', 
                    '<div style="position:fixed;top:0;left:0;right:0;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:12px;z-index:999999;text-align:center;">üîí VPN TUNNEL ACTIVE</div><div style="height:40px;"></div><body');
                
                console.log('[VPN] Creating blob...');
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                console.log('[VPN] Blob URL:', url);
                
                console.log('[VPN] Setting iframe src...');
                frame.src = url;
                
                console.log('[VPN] ‚úì Content loaded successfully');
            }
        }

        const vpn = new VPNTunnel();

        (async () => {
            try {
                await vpn.connect();
                await vpn.request('https://www.netflix.com/');
            } catch (e) {
                console.error('[VPN] Failed:', e);
                document.getElementById('loading').textContent = '‚ùå Failed: ' + e.message;
            }
        })();
    </script>
</body>
</html>
